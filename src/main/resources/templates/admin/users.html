<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
      xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Admin panel</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>
<body>

<div class="row">
    <div class="col bg-dark">
        <nav class="navbar navbar-light bg-dark">
            <span class="navbar-text text-white">
                <b id="currentUserEmail"></b>
                <span>with roles:</span>
                <span id="currentUserRoles"></span>
            </span>
            <a class="nav-link text-secondary font-weight-bold text-right" href="/user/logout">Logout</a>
        </nav>
    </div>
</div>

<div class="row h-100">
    <div class="col-2 bg-white list-group">
        <ul class="nav nav-tabs my-2 flex-column nav-pills">
            <!-- Показываем Admin вкладку для администраторов -->
            <li sec:authorize="hasAuthority('ADMIN')" class="nav-item">
                <a class="nav-link active" href="/admin">Admin</a>
            </li>
            <!-- Показываем User вкладку для всех пользователей -->
            <li class="nav-item">
                <a class="nav-link" href="/user">User</a>
            </li>
        </ul>
    </div>

    <div class="col my-3 mx-3 tab-content">
        <div class="tab-pane active">
            <h2>Admin panel</h2>

            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" href="#" onclick="showUsersTable()">Users table</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showNewUserForm()">New User</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="debugUsers()">Debug</a>
                </li>
            </ul>

            <div id="usersTableContainer" class="tab-pane">
                <h1>All users</h1>
                <div class="row">
                    <div class="col mx-3 border border-light" style="background-color: #ffffff">
                        <div class="row bg-white">
                            <div class="col my-3">
                                <table class="table table-striped" id="usersTable">
                                    <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>First Name</th>
                                        <th>Last Name</th>
                                        <th>Age</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Edit</th>
                                        <th>Delete</th>
                                    </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                    <!-- JavaScript will populate this table -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="newUserFormContainer" class="tab-pane" style="display: none;">
                <h1>Add new user</h1>
                <div class="row">
                    <div class="col mx-3 border border-light" style="background-color: #f5f5f5">
                        <form id="newUserForm">
                            <div class="row bg-white mb-3">
                                <div class="col-12 text-center font-weight-bold">
                                    <label>First Name</label>
                                    <input type="text" name="firstName" id="newFirstName" class="form-control"
                                           placeholder="First Name" required/>
                                </div>
                            </div>

                            <div class="row bg-white mb-3">
                                <div class="col-12 text-center font-weight-bold">
                                    <label>Last Name</label>
                                    <input type="text" name="lastName" id="newLastName" class="form-control"
                                           placeholder="Last Name" required/>
                                </div>
                            </div>

                            <div class="row bg-white mb-3">
                                <div class="col-12 text-center font-weight-bold">
                                    <label>Age</label>
                                    <input type="number" name="age" id="newAge" class="form-control"
                                           placeholder="Age" required/>
                                </div>
                            </div>

                            <div class="row bg-white mb-3">
                                <div class="col-12 text-center font-weight-bold">
                                    <label>Email</label>
                                    <input type="email" name="email" id="newEmail" class="form-control"
                                           placeholder="Email" required/>
                                </div>
                            </div>

                            <div class="row bg-white mb-3">
                                <div class="col-12 text-center font-weight-bold">
                                    <label>Password</label>
                                    <input type="password" name="password" id="newPassword" class="form-control"
                                           placeholder="Password" required/>
                                </div>
                            </div>

                            <div class="row bg-white mb-3">
                                <div class="col-12 text-center font-weight-bold">
                                    <label>Role</label>
                                    <select class="custom-select form-control" multiple name="roles" id="newRoles"
                                            size="2">
                                        <option value="USER">USER</option>
                                        <option value="ADMIN">ADMIN</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row bg-white mb-3">
                                <div class="col-12 text-center">
                                    <button type="submit" class="btn btn-success">Add new user</button>
                                    <button type="button" class="btn btn-secondary" onclick="showUsersTable()">Cancel
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit User</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editUserForm">
                <div class="modal-body">
                    <input type="hidden" id="editUserId">

                    <div class="form-group">
                        <label for="editFirstName">First Name</label>
                        <input type="text" class="form-control" id="editFirstName" required>
                    </div>

                    <div class="form-group">
                        <label for="editLastName">Last Name</label>
                        <input type="text" class="form-control" id="editLastName" required>
                    </div>

                    <div class="form-group">
                        <label for="editAge">Age</label>
                        <input type="number" class="form-control" id="editAge" required>
                    </div>

                    <div class="form-group">
                        <label for="editEmail">Email</label>
                        <input type="email" class="form-control" id="editEmail" required>
                    </div>

                    <div class="form-group">
                        <label for="editPassword">Password</label>
                        <input type="password" class="form-control" id="editPassword"
                               placeholder="Enter new password (leave empty to keep current)">
                    </div>

                    <div class="form-group">
                        <label for="editRoles">Role</label>
                        <select class="custom-select form-control" multiple id="editRoles" size="2">
                            <option value="USER">USER</option>
                            <option value="ADMIN">ADMIN</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="/webjars/jquery/3.4.1/jquery.min.js"></script>
<script src="/webjars/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="/webjars/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script src="/webjars/jquery-cookie/1.4.1/jquery.cookie.js"></script>

<script>
    // Глобальные переменные
    let currentUser = null;
    let allUsers = [];

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function () {
        loadCurrentUser();
        loadUsers();
    });

    // Загрузка текущего пользователя
    async function loadCurrentUser() {
        try {
            const response = await fetch('/api/user/current');
            if (response.ok) {
                currentUser = await response.json();
                displayCurrentUser();
            }
        } catch (error) {
            console.error('Error loading current user:', error);
        }
    }

    // Отображение информации о текущем пользователе
    function displayCurrentUser() {
        if (currentUser) {
            console.log('Displaying current user:', currentUser);
            document.getElementById('currentUserEmail').textContent = currentUser.email;

            // Безопасная обработка ролей
            let rolesText = 'No roles';
            if (currentUser.roles && Array.isArray(currentUser.roles) && currentUser.roles.length > 0) {
                const roleNames = currentUser.roles.map(role => {
                    console.log('Processing role:', role);
                    return role.name || role;
                });
                rolesText = roleNames.join(' ');
            }
            console.log('Roles text:', rolesText);
            document.getElementById('currentUserRoles').textContent = rolesText;
        } else {
            console.log('No current user to display');
        }
    }

    // Загрузка всех пользователей
    async function loadUsers() {
        try {
            console.log('Loading users...');
            const response = await fetch('/api/admin/users');
            console.log('Response status:', response.status);

            if (response.ok) {
                allUsers = await response.json();
                console.log('Received users:', allUsers);

                // Проверяем структуру каждого пользователя
                allUsers.forEach((user, index) => {
                    console.log(`User ${index}:`, user);
                    if (user.roles) {
                        console.log(`User ${index} roles:`, user.roles);
                    }
                });

                displayUsers();
            } else {
                console.error('Failed to load users, status:', response.status);
                const errorText = await response.text();
                console.error('Error response:', errorText);
            }
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    // Отображение пользователей в таблице
    function displayUsers() {
        console.log('Displaying users:', allUsers);
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';

        if (!allUsers || allUsers.length === 0) {
            console.log('No users to display');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">No users found</td></tr>';
            return;
        }

        allUsers.forEach((user, index) => {
            console.log(`Processing user ${index}:`, user);

            // Безопасная обработка ролей
            let rolesText = 'No roles';
            if (user.roles && Array.isArray(user.roles) && user.roles.length > 0) {
                const roleNames = user.roles.map(role => {
                    console.log(`Role for user ${index}:`, role);
                    return role.name || role;
                });
                rolesText = roleNames.join(', ');
            }
            console.log(`Roles text for user ${index}:`, rolesText);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.id || 'N/A'}</td>
                <td>${user.firstName || 'N/A'}</td>
                <td>${user.lastName || 'N/A'}</td>
                <td>${user.age || 'N/A'}</td>
                <td>${user.email || 'N/A'}</td>
                <td>${rolesText}</td>
                <td>
                    <button type="button" class="btn btn-primary btn-sm" onclick="editUser(${user.id})">
                        Edit
                    </button>
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">
                        Delete
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    // Переключение между таблицей пользователей и формой создания
    function showUsersTable() {
        document.getElementById('usersTableContainer').style.display = 'block';
        document.getElementById('newUserFormContainer').style.display = 'none';
        loadUsers();
    }

    function showNewUserForm() {
        document.getElementById('usersTableContainer').style.display = 'none';
        document.getElementById('newUserFormContainer').style.display = 'block';
        document.getElementById('newUserForm').reset();
    }

    // Создание нового пользователя
    document.getElementById('newUserForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const userData = {
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            age: parseInt(formData.get('age')),
            email: formData.get('email'),
            password: formData.get('password'),
            roles: Array.from(document.getElementById('newRoles').selectedOptions).map(option => option.value)
        };

        try {
            const response = await fetch('/api/admin/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            });

            if (response.ok) {
                alert('User created successfully!');
                showUsersTable();
            } else if (response.status === 409) {
                alert('User with this email already exists!');
            } else {
                alert('Error creating user. Please check all fields.');
            }
        } catch (error) {
            console.error('Error creating user:', error);
            alert('Error creating user');
        }
    });

    // Редактирование пользователя
    async function editUser(userId) {
        try {
            console.log('Editing user with ID:', userId);
            const response = await fetch(`/api/admin/users/${userId}`);
            if (response.ok) {
                const user = await response.json();
                console.log('User data for edit:', user);

                document.getElementById('editUserId').value = user.id;
                document.getElementById('editFirstName').value = user.firstName;
                document.getElementById('editLastName').value = user.lastName;
                document.getElementById('editAge').value = user.age;
                document.getElementById('editEmail').value = user.email;
                document.getElementById('editPassword').value = '';

                // Сбрасываем и устанавливаем роли
                const roleSelect = document.getElementById('editRoles');
                const userRoleNames = [];

                if (user.roles && Array.isArray(user.roles) && user.roles.length > 0) {
                    user.roles.forEach(role => {
                        console.log('Processing role for edit:', role);
                        const roleName = role.name || role;
                        userRoleNames.push(roleName);
                    });
                }

                console.log('User role names for edit:', userRoleNames);

                Array.from(roleSelect.options).forEach(option => {
                    option.selected = userRoleNames.includes(option.value);
                });

                $('#editModal').modal('show');
            } else {
                console.error('Failed to load user for edit, status:', response.status);
                const errorText = await response.text();
                console.error('Error response:', errorText);
            }
        } catch (error) {
            console.error('Error loading user for edit:', error);
        }
    }

    // Обновление пользователя
    document.getElementById('editUserForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const userId = document.getElementById('editUserId').value;
        const userData = {
            firstName: document.getElementById('editFirstName').value,
            lastName: document.getElementById('editLastName').value,
            age: parseInt(document.getElementById('editAge').value),
            email: document.getElementById('editEmail').value,
            password: document.getElementById('editPassword').value,
            roles: Array.from(document.getElementById('editRoles').selectedOptions).map(option => option.value)
        };

        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            });

            if (response.ok) {
                alert('User updated successfully!');
                $('#editModal').modal('hide');
                loadUsers();
            } else if (response.status === 404) {
                alert('User not found!');
            } else {
                alert('Error updating user. Please check all fields.');
            }
        } catch (error) {
            console.error('Error updating user:', error);
            alert('Error updating user');
        }
    });

    // Удаление пользователя
    async function deleteUser(userId) {
        if (confirm('Are you sure you want to delete this user?')) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('User deleted successfully!');
                    loadUsers();
                } else {
                    alert('Error deleting user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Error deleting user');
            }
        }
    }

    // Отладочная функция
    async function debugUsers() {
        try {
            console.log('Debugging users...');
            const response = await fetch('/api/admin/debug/users');
            console.log('Debug response status:', response.status);

            if (response.ok) {
                const debugInfo = await response.json();
                console.log('Debug info:', debugInfo);
                alert('Debug info logged to console. Check browser console for details.');
            } else {
                console.error('Failed to get debug info, status:', response.status);
                alert('Failed to get debug info');
            }
        } catch (error) {
            console.error('Error debugging users:', error);
            alert('Error debugging users');
        }
    }
</script>

</body>
</html>